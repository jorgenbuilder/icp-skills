# PicJS Reference

## Install and prerequisites

- Package: PicJS
- Runtime: Node or Bun (other runtimes are not officially supported)
- Use the repo's existing package manager and test runner.

## Jest setup (default if no runner)

1. Install dependencies (use your package manager):
   - `jest`, `@types/jest`, `@types/node`, `@swc/core`, `@swc/jest`
2. Add `jest.config.ts` with `globalSetup` and `globalTeardown`.
3. Create `global-setup.ts` and `global-teardown.ts` to start/stop `PocketIcServer`.
4. Expose `PIC_URL` via `process.env` and store the server instance on `global`.

## `vitest` setup

1. Install `vitest` and `@types/node`.
2. Create `global-setup.ts` that starts `PocketIcServer` and `ctx.provide('PIC_URL', url)`.
3. Create `vitest.config.ts` with `globalSetup`.
4. Use `inject('PIC_URL')` in tests.

## Bun setup

1. Install `@types/bun`.
2. Create `global-setup.ts` using `beforeAll`/`afterAll` to start/stop `PocketIcServer`.
3. Add `bunfig.toml` preload for the global setup.
4. If Bun is the package manager, add the PicJS package to `trustedDependencies`.

## Test skeleton essentials

- Create `PocketIc` from `PIC_URL`.
- Install canister with `setupCanister({ idlFactory, wasm })`.
- Use `fixture.actor` for calls and `fixture.canisterId` for IDs.
- Call `pic.tearDown()` after each test or after all tests.

## Canister declarations (DFX < 0.16.0)

If older DFX is in use, add shims to export `idlFactory` and `init` to avoid broken
autogenerated declarations:

- `index.js`: `export { idlFactory, init } from '../../declarations/<canister>.did';`
- `index.d.ts`: re-export `idlFactory` and `init` with correct types.

## Logging and diagnostics

- Canister logs: `PocketIcServer.start({ showCanisterLogs: true })`
- Runtime logs: `PocketIcServer.start({ showRuntimeLogs: true })`
- Server logs: set `POCKET_IC_LOG_DIR` and `POCKET_IC_LOG_DIR_LEVELS`

## Sources

- [PicJS docs](https://js.icp.build/pic-js/latest)
- [Getting started](https://js.icp.build/pic-js/latest/guides/getting-started)
- [Using Jest](https://js.icp.build/pic-js/latest/guides/using-jest)
- [Using Bun](https://js.icp.build/pic-js/latest/guides/using-bun)
- [Running tests](https://js.icp.build/pic-js/latest/guides/running-tests)
- [Canister declarations](https://js.icp.build/pic-js/latest/guides/canister-declarations)
- [More examples](https://js.icp.build/pic-js/latest/guides/more-examples)
- [API overview](https://js.icp.build/pic-js/latest/api/)
