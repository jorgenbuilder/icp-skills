#!/bin/bash
# makespace - Create a new project from agentspace-template
#
# Usage: makespace <repo-name> [options]
#
# Options:
#   --public          Create a public repository (default: private)
#   --private         Create a private repository (default)
#   --owner <owner>   Specify repository owner (default: jorgenbuilder)
#   --template <repo> Specify template repository (default: jorgenbuilder/agentspace-template)
#   --help            Show this help message

set -e

# Default configuration
DEFAULT_OWNER="jorgenbuilder"
DEFAULT_TEMPLATE="jorgenbuilder/agentspace-template"
DEFAULT_VISIBILITY="private"

# Parse arguments
REPO_NAME=""
OWNER="$DEFAULT_OWNER"
TEMPLATE="$DEFAULT_TEMPLATE"
VISIBILITY="$DEFAULT_VISIBILITY"

show_usage() {
  cat << EOF
makespace - Create a new project from agentspace-template

Usage: makespace <repo-name> [options]

Arguments:
  <repo-name>       Name of the new repository to create

Options:
  --public          Create a public repository (default: private)
  --private         Create a private repository (default)
  --owner <owner>   Specify repository owner (default: $DEFAULT_OWNER)
  --template <repo> Specify template repository (default: $DEFAULT_TEMPLATE)
  --help            Show this help message

Examples:
  makespace my-project
  makespace my-project --public
  makespace my-project --owner myorg --private
  makespace my-project --template myorg/custom-template

Requirements:
  - GitHub CLI (gh) must be installed and authenticated
  - User Codespaces secrets must exist: ANTHROPIC_API_KEY, GH_PAT
  - jq must be installed

EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --help)
      show_usage
      exit 0
      ;;
    --public)
      VISIBILITY="public"
      shift
      ;;
    --private)
      VISIBILITY="private"
      shift
      ;;
    --owner)
      OWNER="$2"
      shift 2
      ;;
    --template)
      TEMPLATE="$2"
      shift 2
      ;;
    -*)
      echo "Unknown option: $1"
      show_usage
      exit 1
      ;;
    *)
      if [ -z "$REPO_NAME" ]; then
        REPO_NAME="$1"
      else
        echo "Error: Multiple repository names provided"
        show_usage
        exit 1
      fi
      shift
      ;;
  esac
done

# Validate repo name was provided
if [ -z "$REPO_NAME" ]; then
  echo "Error: Repository name is required"
  echo ""
  show_usage
  exit 1
fi

# Build full repository slug
REPO_SLUG="$OWNER/$REPO_NAME"

echo "==> Creating new agentspace: $REPO_SLUG"
echo ""
echo "Configuration:"
echo "  Repository: $REPO_SLUG"
echo "  Template: $TEMPLATE"
echo "  Visibility: $VISIBILITY"
echo ""

# Check prerequisites
echo "==> Checking prerequisites..."

if ! command -v gh >/dev/null 2>&1; then
  echo "❌ ERROR: GitHub CLI (gh) is not installed"
  echo "Install from: https://cli.github.com/"
  exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
  echo "❌ ERROR: jq is not installed"
  echo "Install with: brew install jq (macOS) or apt-get install jq (Linux)"
  exit 1
fi

if ! gh auth status >/dev/null 2>&1; then
  echo "❌ ERROR: GitHub CLI is not authenticated"
  echo "Run: gh auth login"
  exit 1
fi

echo "✅ Prerequisites satisfied"
echo ""

# Step 1: Create repository from template and clone
echo "==> Step 1: Creating repository from template..."

VISIBILITY_FLAG="--$VISIBILITY"

if gh api "repos/$REPO_SLUG" >/dev/null 2>&1; then
  echo "❌ ERROR: Repository $REPO_SLUG already exists"
  echo "Choose a different name or delete the existing repository"
  exit 1
fi

if ! gh repo create "$REPO_SLUG" --template "$TEMPLATE" $VISIBILITY_FLAG --clone; then
  echo "❌ ERROR: Failed to create repository from template"
  exit 1
fi

echo "✅ Repository created and cloned"
echo ""

# Step 2: Navigate to repository directory
echo "==> Step 2: Navigating to repository directory..."
cd "$REPO_NAME"
echo "✅ In directory: $(pwd)"
echo ""

# Step 3: Get repository ID
echo "==> Step 3: Getting repository ID..."
REPO_ID=$(gh api "repos/$REPO_SLUG" --jq .id 2>/dev/null)

if [ -z "$REPO_ID" ]; then
  echo "❌ ERROR: Failed to get repository ID"
  exit 1
fi

echo "✅ Repository ID: $REPO_ID"
echo ""

# Step 4: Attach Codespaces secrets
echo "==> Step 4: Attaching Codespaces secrets..."

SECRETS=("ANTHROPIC_API_KEY" "GH_PAT")
FAILED_SECRETS=()

for SECRET in "${SECRETS[@]}"; do
  echo "  Attaching: $SECRET"
  if gh api -X PUT "/user/codespaces/secrets/$SECRET/repositories/$REPO_ID" >/dev/null 2>&1; then
    echo "    ✅ Attached: $SECRET"
  else
    echo "    ❌ Failed: $SECRET"
    FAILED_SECRETS+=("$SECRET")
  fi
done

if [ ${#FAILED_SECRETS[@]} -gt 0 ]; then
  echo ""
  echo "❌ ERROR: Failed to attach secrets: ${FAILED_SECRETS[*]}"
  echo "Ensure these secrets exist in your user Codespaces secrets:"
  echo "  https://github.com/settings/codespaces"
  exit 1
fi

echo "✅ All secrets attached"
echo ""

# Step 5: Create and open Codespace
echo "==> Step 5: Creating Codespace..."
echo "This will open in your browser when ready..."
echo ""

if ! gh codespace create --repo "$REPO_SLUG" --branch main --machine basicLinux32gb; then
  echo "❌ ERROR: Failed to create Codespace"
  echo "You can create it manually from: https://github.com/$REPO_SLUG"
  exit 1
fi

echo ""
echo "✅ Codespace created successfully!"
echo ""
echo "==> Summary:"
echo "  Repository: https://github.com/$REPO_SLUG"
echo "  Local path: $(pwd)"
echo "  Codespace: Creating... (will open in browser)"
echo ""
echo "The Codespace will bootstrap automatically (3-5 minutes)."
echo "See VERIFY.md in the repository for verification steps."
